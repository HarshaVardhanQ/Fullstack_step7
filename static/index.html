<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>People Manager</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <main class="app">
    <header class="app-header">
      <h1>People Manager</h1>
      <div id="userbox" class="userbox hidden">
        <span id="usernameDisplay"></span>
        <button id="logoutBtn" class="btn small">Logout</button>
      </div>
    </header>

    <section id="message" class="message hidden" role="status"></section>

    <!-- Auth area -->
    <section id="auth" class="card auth-card">
      <div class="tabs">
        <button id="tabLogin" class="tab active">Login</button>
        <button id="tabSignup" class="tab">Sign up</button>
      </div>

      <form id="loginForm" class="form">
        <label>Username<input name="username" required /></label>
        <label>Password<input name="password" type="password" required /></label>
        <div class="form-actions">
          <button class="btn" type="submit">Login</button>
        </div>
      </form>

      <form id="signupForm" class="form hidden">
        <label>Username<input name="username" required /></label>
        <label>Password<input name="password" type="password" required /></label>
        <div class="form-actions">
          <button class="btn" type="submit">Create account</button>
        </div>
      </form>
    </section>

    <!-- App area -->
    <section id="appArea" class="hidden">
      <div class="controls card">
        <form id="createForm" class="inline-form">
          <input name="name" placeholder="Name" required />
          <input name="roll" placeholder="Roll" required />
          <input name="age" type="number" placeholder="Age" min="0" required />
          <select name="gender" required>
            <option value="">Gender</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
          <button class="btn" type="submit">Add</button>
        </form>

        <div class="search-row">
          <input id="searchInput" placeholder="Search by name..." />
          <button id="searchBtn" class="btn small">Search</button>
          <button id="clearSearchBtn" class="btn small ghost">Clear</button>
        </div>
      </div>

      <div class="card">
        <table class="people-table" aria-live="polite">
          <thead>
            <tr>
              <th># (user)</th>
              <th>Name</th>
              <th>Roll</th>
              <th>Age</th>
              <th>Gender</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="peopleBody">
            <!-- rows inserted here -->
          </tbody>
        </table>

        <div class="pagination">
          <button id="prevPage" class="btn small">Prev</button>
          <span id="pageInfo"></span>
          <button id="nextPage" class="btn small">Next</button>
        </div>
      </div>

      <!-- Edit drawer -->
      <aside id="editDrawer" class="drawer hidden">
        <h3>Edit person</h3>
        <form id="editForm" class="form">
          <input name="id" type="hidden" />
          <label>Name<input name="name" required /></label>
          <label>Roll<input name="roll" required /></label>
          <label>Age<input name="age" type="number" min="0" required /></label>
          <label>Gender
            <select name="gender" required>
              <option>Male</option>
              <option>Female</option>
              <option>Other</option>
            </select>
          </label>

          <div class="form-actions">
            <button class="btn" type="submit">Save</button>
            <button id="cancelEdit" class="btn ghost" type="button">Cancel</button>
          </div>
        </form>
      </aside>
    </section>

    <footer class="app-footer">Built with FastAPI — static frontend for the People Manager</footer>
  </main>

  <script>
    // --- Basic state ---
    const state = {
      token: localStorage.getItem('pm_token') || null,
      username: localStorage.getItem('pm_user') || null,
      skip: 0,
      limit: 10,
      totalLoaded: 0,
      search: '',
    };

    // --- Helpers ---
    const el = id => document.getElementById(id);
    const q = s => document.querySelector(s);

    function showMessage(msg, type = 'info', timeout = 4000) {
      const m = el('message');
      if (!m) return console.warn('message element missing');
      m.textContent = msg;
      m.className = 'message ' + type;
      m.classList.remove('hidden');
      if (timeout > 0) setTimeout(() => m.classList.add('hidden'), timeout);
    }

    async function apiFetch(path, opts = {}) {
      const headers = opts.headers || {};
      if (opts.body) headers['Content-Type'] = 'application/json';
      if (state.token) headers['Authorization'] = 'Bearer ' + state.token;
      const response = await fetch(path, { ...opts, headers });
      const ct = response.headers.get('content-type') || '';
      let body = null;
      if (ct.includes('application/json')) body = await response.json();
      if (!response.ok) {
        const msg = body?.detail || body?.message || response.statusText || 'Request failed';
        throw new Error(msg);
      }
      return body;
    }

    // --- Auth UI (single-init guard) ---
    const auth = {
      _inited: false,
      init() {
        if (this._inited) return;
        this._inited = true;

        this.loginForm = el('loginForm');
        this.signupForm = el('signupForm');
        this.tabLogin = el('tabLogin');
        this.tabSignup = el('tabSignup');
        // find submit buttons (for disabling while request in-flight)
        this.loginBtn = this.loginForm.querySelector('button[type="submit"]');
        this.signupBtn = this.signupForm.querySelector('button[type="submit"]');

        this.tabLogin.addEventListener('click', () => this.showLogin());
        this.tabSignup.addEventListener('click', () => this.showSignup());
        this.loginForm.addEventListener('submit', e => this.handleLogin(e));
        this.signupForm.addEventListener('submit', e => this.handleSignup(e));
      },

      showLogin() {
        this.tabLogin.classList.add('active');
        this.tabSignup.classList.remove('active');
        this.loginForm.classList.remove('hidden');
        this.signupForm.classList.add('hidden');
      },

      showSignup() {
        this.tabLogin.classList.remove('active');
        this.tabSignup.classList.add('active');
        this.loginForm.classList.add('hidden');
        this.signupForm.classList.remove('hidden');
      },

      async handleLogin(e) {
        e.preventDefault();
        const fd = new FormData(this.loginForm);
        const username = fd.get('username');
        const password = fd.get('password');
        if (!username || !password) return showMessage('Enter username and password', 'error');

        try {
          if (this.loginBtn) this.loginBtn.disabled = true;
          const body = { username, password };
          const res = await apiFetch('/auth/login', { method: 'POST', body: JSON.stringify(body) });
          state.token = res.access_token;
          state.username = username;
          localStorage.setItem('pm_token', state.token);
          localStorage.setItem('pm_user', state.username);

          // DON'T re-init the whole app — only update visibility
          appUI.updateAuthVisibility();
          showMessage('Logged in');
        } catch (err) {
          showMessage('Login failed: ' + err.message, 'error');
        } finally {
          if (this.loginBtn) this.loginBtn.disabled = false;
        }
      },

      async handleSignup(e) {
        e.preventDefault();
        const fd = new FormData(this.signupForm);
        const username = fd.get('username');
        const password = fd.get('password');
        if (!username || !password) return showMessage('Enter username and password', 'error');

        try {
          if (this.signupBtn) this.signupBtn.disabled = true;
          const body = { username, password };
          await apiFetch('/auth/signup', { method: 'POST', body: JSON.stringify(body) });
          showMessage('Account created — you can now log in');
          this.showLogin();
        } catch (err) {
          showMessage('Signup failed: ' + err.message, 'error');
        } finally {
          if (this.signupBtn) this.signupBtn.disabled = false;
        }
      }
    };

    // --- App UI (single-init guard) ---
    const appUI = {
      _inited: false,
      init() {
        if (this._inited) return;
        this._inited = true;

        this.appArea = el('appArea');
        this.authCard = el('auth');
        this.userbox = el('userbox');
        this.usernameDisplay = el('usernameDisplay');
        this.logoutBtn = el('logoutBtn');
        this.createForm = el('createForm');
        this.createBtn = this.createForm.querySelector('button[type="submit"]');
        this.peopleBody = el('peopleBody');
        this.searchInput = el('searchInput');
        this.searchBtn = el('searchBtn');
        this.clearSearchBtn = el('clearSearchBtn');
        this.prevPage = el('prevPage');
        this.nextPage = el('nextPage');
        this.pageInfo = el('pageInfo');
        this.editDrawer = el('editDrawer');
        this.editForm = el('editForm');
        this.cancelEdit = el('cancelEdit');

        this.logoutBtn.addEventListener('click', () => this.logout());
        this.createForm.addEventListener('submit', e => this.createPerson(e));
        this.searchBtn.addEventListener('click', () => this.search());
        this.clearSearchBtn.addEventListener('click', () => this.clearSearch());
        this.searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); this.search(); } });
        this.prevPage.addEventListener('click', () => this.changePage(-1));
        this.nextPage.addEventListener('click', () => this.changePage(1));
        this.editForm.addEventListener('submit', e => this.saveEdit(e));
        this.cancelEdit.addEventListener('click', () => this.closeEdit());

        // event delegation for action buttons in the table
        this.peopleBody.addEventListener('click', (ev) => {
          const btn = ev.target.closest && ev.target.closest('button[data-action]');
          if (!btn) return;
          const action = btn.getAttribute('data-action');
          const id = Number(btn.getAttribute('data-id'));
          if (action === 'edit') this.openEdit(id);
          if (action === 'delete') this.deletePerson(id);
        });

        // initial visibility
        this.updateAuthVisibility();
      },

      updateAuthVisibility() {
        const loggedIn = !!state.token;
        if (loggedIn) {
          this.authCard.classList.add('hidden');
          this.appArea.classList.remove('hidden');
          this.userbox.classList.remove('hidden');
          this.usernameDisplay.textContent = state.username || '';
          this.loadPeople();
        } else {
          this.authCard.classList.remove('hidden');
          this.appArea.classList.add('hidden');
          this.userbox.classList.add('hidden');
        }
      },

      logout() {
        state.token = null;
        state.username = null;
        localStorage.removeItem('pm_token');
        localStorage.removeItem('pm_user');
        showMessage('Logged out');
        this.updateAuthVisibility();
      },

      async createPerson(e) {
        e.preventDefault();
        const fd = new FormData(this.createForm);
        const body = {
          name: fd.get('name'),
          roll: fd.get('roll'),
          age: Number(fd.get('age')),
          gender: fd.get('gender') || 'Other',
        };

        try {
          if (this.createBtn) this.createBtn.disabled = true;
          const res = await apiFetch('/persons', { method: 'POST', body: JSON.stringify(body) });
          showMessage(res.message || 'Created');
          this.createForm.reset();
          this.loadPeople();
        } catch (err) {
          showMessage('Create failed: ' + err.message, 'error');
        } finally {
          if (this.createBtn) this.createBtn.disabled = false;
        }
      },

      async loadPeople() {
        try {
          const q = [];
          q.push('skip=' + state.skip);
          q.push('limit=' + state.limit);
          if (state.search) q.push('search=' + encodeURIComponent(state.search));
          const url = '/persons?' + q.join('&');
          const res = await apiFetch(url, { method: 'GET' });
          this.renderList(res.items || []);
          this.pageInfo.textContent = `Showing ${res.items ? res.items.length : 0} (skip ${state.skip})`;
          state.totalLoaded = (res.items || []).length;
        } catch (err) {
          showMessage('Failed to load people: ' + err.message, 'error');
        }
      },

      renderList(items) {
        this.peopleBody.innerHTML = '';
        items.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.user_person_id ?? item.id}</td>
            <td>${escapeHtml(item.name)}</td>
            <td>${escapeHtml(item.roll)}</td>
            <td>${item.age}</td>
            <td>${escapeHtml(item.gender)}</td>
            <td class="actions">
              <button class="btn small" data-action="edit" data-id="${item.user_person_id ?? item.id}">Edit</button>
              <button class="btn small danger" data-action="delete" data-id="${item.user_person_id ?? item.id}">Delete</button>
            </td>
          `;
          this.peopleBody.appendChild(tr);
        });
      },

      async openEdit(personId) {
        try {
          const p = await apiFetch('/persons/' + personId, { method: 'GET' });
          this.editForm.id.value = personId;
          this.editForm.name.value = p.name;
          this.editForm.roll.value = p.roll;
          this.editForm.age.value = p.age;
          this.editForm.gender.value = p.gender;
          this.editDrawer.classList.remove('hidden');
        } catch (err) {
          showMessage('Failed to fetch person: ' + err.message, 'error');
        }
      },

      closeEdit() {
        this.editDrawer.classList.add('hidden');
      },

      async saveEdit(e) {
        e.preventDefault();
        const fd = new FormData(this.editForm);
        const id = fd.get('id');
        const body = {
          name: fd.get('name'),
          roll: fd.get('roll'),
          age: Number(fd.get('age')),
          gender: fd.get('gender'),
        };
        try {
          const res = await apiFetch('/persons/' + id, { method: 'PUT', body: JSON.stringify(body) });
          showMessage(res.message || 'Updated');
          this.closeEdit();
          this.loadPeople();
        } catch (err) {
          showMessage('Update failed: ' + err.message, 'error');
        }
      },

      async deletePerson(personId) {
        if (!confirm('Delete this person?')) return;
        try {
          const res = await apiFetch('/persons/' + personId, { method: 'DELETE' });
          showMessage(res.message || 'Deleted');
          this.loadPeople();
        } catch (err) {
          showMessage('Delete failed: ' + err.message, 'error');
        }
      },

      search() {
        state.search = this.searchInput.value.trim();
        state.skip = 0;
        this.loadPeople();
      },

      clearSearch() {
        this.searchInput.value = '';
        state.search = '';
        state.skip = 0;
        this.loadPeople();
      },

      changePage(delta) {
        state.skip = Math.max(0, state.skip + delta * state.limit);
        this.loadPeople();
      }
    };

    // --- Utilities ---
    function escapeHtml(s) {
      if (s == null) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // --- Single initialization on load ---
    window.addEventListener('DOMContentLoaded', () => {
      auth.init();
      appUI.init();
      // ensure visibility follows login state (don't re-init)
      appUI.updateAuthVisibility();
    });
  </script>

  <!-- styles.css (place this content in static/styles.css) -->
  <!--
  Paste the block below into a new file at static/styles.css
  -->
  <!-- styles.css -->
  <style id="styles-block" media="none">
  /*
  : File: static/styles.css
  */
  :root {
    --bg: #fbfdff;
    --card: #ffffff;
    --text: #1e293b;
    --muted: #64748b;
    --accent: #0b76ff;
    --danger: #ff4d4f;
    --shadow: rgba(16,24,40,0.06);
  }

  * { box-sizing: border-box; }
  html,body,#root { height: 100%; }
  body {
    margin: 0;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg, var(--bg), #f6f9ff 100%);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .app { max-width: 980px; margin: 28px auto; padding: 16px; }
  .app-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
  .app-header h1 { margin:0; font-size:20px; }

  .card { background: var(--card); padding: 12px; border-radius: 12px; box-shadow: 0 6px 18px var(--shadow); margin-bottom: 12px; }
  .auth-card { max-width:520px; margin:0 auto 12px; }

  .tabs { display:flex; gap:8px; margin-bottom:8px; }
  .tab { padding:8px 12px; border-radius:8px; background:transparent; border:1px solid transparent; cursor:pointer; }
  .tab.active { background:var(--accent); color:white; }

  .form label { display:block; margin-bottom:8px; }
  .form input, .form select { width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e6eef9; background: #fbfdff; }
  .inline-form { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .inline-form input, .inline-form select { min-width:140px; }
  .form-actions { display:flex; gap:8px; margin-top:8px; }

  .btn { background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .btn.ghost { background:transparent; color:var(--accent); border:1px solid var(--accent); }
  .btn.small { padding:6px 8px; font-size:13px; }
  .btn.danger { background:var(--danger); }

  .search-row { display:flex; gap:8px; margin-top:8px; align-items:center; }
  .search-row input { flex:1; }

  .people-table { width:100%; border-collapse:collapse; }
  .people-table th, .people-table td { text-align:left; padding:8px; border-bottom:1px solid #f1f5f9; }
  .people-table thead th { font-size:13px; color:var(--muted); }
  .people-table tbody tr:hover { background:#fbfcff; }
  .actions { display:flex; gap:6px; }

  .pagination { display:flex; gap:8px; align-items:center; justify-content:center; padding:10px 0; }

  .message { padding:8px 12px; border-radius:8px; margin-bottom:12px; }
  .message.hidden { display:none; }
  .message.info { background:#e6f0ff; color:var(--text); }
  .message.error { background:#fff0f0; color:var(--danger); }

  .drawer { position:fixed; right:16px; top:80px; width:320px; background:var(--card); padding:12px; border-radius:12px; box-shadow:0 10px 30px var(--shadow); }
  .drawer.hidden { display:none; }

  .userbox { display:flex; gap:8px; align-items:center; }

  .hidden { display:none !important; }

  .app-footer { margin-top:18px; text-align:center; color:var(--muted); font-size:13px; }
  </style>

</body>
</html>
